#!/bin/bash

# Fonction pour vÃ©rifier si Docker est en cours d'exÃ©cution
check_docker() {
    if ! docker info >/dev/null 2>&1; then
        echo "âŒ Erreur: Docker n'est pas en cours d'exÃ©cution."
        echo "â¡ï¸  Veuillez dÃ©marrer Docker et rÃ©essayer."
        exit 1
    fi
}

# Fonction pour vÃ©rifier si docker-compose est installÃ©
check_docker_compose() {
    if ! command -v docker-compose >/dev/null 2>&1; then
        echo "âŒ Erreur: docker-compose n'est pas installÃ©."
        echo "â¡ï¸  Veuillez installer docker-compose et rÃ©essayer."
        exit 1
    fi
}

# Fonction pour vÃ©rifier si les dossiers nÃ©cessaires existent
check_directories() {
    local missing_dirs=()
    for dir in api web mobile; do
        if [ ! -d "$dir" ]; then
            missing_dirs+=($dir)
        fi
    done

    if [ ${#missing_dirs[@]} -ne 0 ]; then
        echo "âŒ Erreur: Les dossiers suivants sont manquants:"
        printf '  - %s\n' "${missing_dirs[@]}"
        exit 1
    fi
}

# Fonction pour vÃ©rifier si les Dockerfiles existent
check_dockerfiles() {
    local missing_files=()
    for dir in api web mobile; do
        if [ ! -f "$dir/Dockerfile" ]; then
            missing_files+=($dir/Dockerfile)
        fi
    done

    if [ ${#missing_files[@]} -ne 0 ]; then
        echo "âŒ Erreur: Les Dockerfiles suivants sont manquants:"
        printf '  - %s\n' "${missing_files[@]}"
        exit 1
    fi
}

# Fonction pour vÃ©rifier si les images existent dÃ©jÃ 
check_images() {
    # Utiliser docker-compose pour lister les images
    if docker-compose images -q | grep -q "^$"; then
        echo "true"  # Images manquantes
    else
        echo "false" # Images existantes
    fi
}

# Fonction pour arrÃªter proprement les conteneurs
cleanup() {
    echo -e "\n\nğŸ›‘ ArrÃªt des conteneurs..."
    docker-compose stop
    echo "âœ… Tous les conteneurs ont Ã©tÃ© arrÃªtÃ©s."
    exit 0
}

# Fonction pour redÃ©marrer les conteneurs
restart() {
    echo -e "\n\nğŸ”„ RedÃ©marrage des conteneurs..."
    if ! docker-compose restart; then
        echo "âŒ Erreur lors du redÃ©marrage des conteneurs."
        exit 1
    fi
    echo "âœ… Tous les conteneurs ont Ã©tÃ© redÃ©marrÃ©s!"
    echo "ğŸ“Š Reprise de l'affichage des logs..."
}

# Fonction pour gÃ©rer les signaux
handle_signal() {
    case $1 in
        SIGINT|SIGTERM)
            cleanup
            ;;
        SIGQUIT)  # CTRL+R envoie SIGQUIT
            restart
            ;;
    esac
}

case "$1" in
    "all")
        echo "ğŸ” VÃ©rification de l'environnement..."
        
        check_docker
        check_docker_compose
        check_directories
        check_dockerfiles

        # VÃ©rifier si c'est le premier dÃ©marrage
        needs_build=$(check_images)
        
        echo "ğŸš€ DÃ©marrage de tous les conteneurs..."
        
        # Capture des signaux (CTRL+C et CTRL+R)
        trap 'handle_signal SIGINT' SIGINT
        trap 'handle_signal SIGTERM' SIGTERM
        trap 'handle_signal SIGQUIT' SIGQUIT
        
        if [ "$needs_build" = "true" ]; then
            echo "ğŸ“¦ Premier dÃ©marrage dÃ©tectÃ© - Construction des images..."
            if ! docker-compose up -d --build; then
                echo "âŒ Erreur lors de la construction des images."
                echo "ğŸ“‹ Logs de l'erreur:"
                docker-compose logs
                exit 1
            fi
            echo "âœ… Images construites avec succÃ¨s!"
        else
            echo "ğŸ“¦ Utilisation des images existantes..."
            if ! docker-compose up -d; then
                echo "âŒ Erreur lors du dÃ©marrage des conteneurs."
                echo "ğŸ“‹ Logs de l'erreur:"
                docker-compose logs
                exit 1
            fi
        fi

        echo "âœ… Conteneurs dÃ©marrÃ©s avec succÃ¨s!"
        echo "ğŸ“Š Affichage des logs..."
        echo "â„¹ï¸  Utilisez CTRL+C pour arrÃªter ou CTRL+R pour redÃ©marrer la stack"
        
        while true; do
            docker-compose logs -f || true
            # Si on sort des logs sans signal (erreur), on attend un peu
            sleep 1
        done
        ;;
    *)
        echo "Usage: bin/up all"
        exit 1
        ;;
esac 