#!/bin/bash

# Couleurs pour les logs
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Variables pour suivre l'√©tat des actions
ENV_DIR_STATUS="‚ùå"
ENV_API_STATUS="‚ùå"
ENV_WEB_STATUS="‚ùå"
ENV_MOBILE_STATUS="‚ùå"
GITIGNORE_STATUS="‚ùå"

# Fonction pour les logs
log_info() {
    echo -e "${BLUE}‚ÑπÔ∏è $1${NC}"
}

log_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

# Cr√©ation du dossier env s'il n'existe pas
log_info "Cr√©ation du dossier env..."
if mkdir -p env; then
    ENV_DIR_STATUS="‚úÖ"
    log_success "Dossier env cr√©√©"
else
    log_warning "Erreur lors de la cr√©ation du dossier env"
fi

# Configuration de l'API
log_info "Configuration de l'API..."
if cat > env/.env.api << EOL
# Configuration de l'API
PORT=8000
HOST=0.0.0.0
CORS_ORIGINS=http://localhost:3000,http://web:3000
EOL
then
    ENV_API_STATUS="‚úÖ"
    log_success "Fichier .env.api cr√©√©"
else
    log_warning "Erreur lors de la cr√©ation du fichier .env.api"
fi

# Configuration du frontend web
log_info "Configuration du frontend web..."
if cat > env/.env.web << EOL
# Configuration du frontend web
NUXT_PUBLIC_API_URL=http://api:8000
PORT=3000
HOST=0.0.0.0
EOL
then
    ENV_WEB_STATUS="‚úÖ"
    log_success "Fichier .env.web cr√©√©"
else
    log_warning "Erreur lors de la cr√©ation du fichier .env.web"
fi

# Configuration du mobile
log_info "Configuration du mobile..."
if cat > env/.env.mobile << EOL
# Configuration de l'application mobile Flutter
PORT=5000
HOST=0.0.0.0
FLUTTER_API_URL=http://api:8000
FLUTTER_APP_NAME=Arosa-je Mobile
FLUTTER_DEBUG=true
EOL
then
    ENV_MOBILE_STATUS="‚úÖ"
    log_success "Fichier .env.mobile cr√©√©"
else
    log_warning "Erreur lors de la cr√©ation du fichier .env.mobile"
fi

# Ajout des fichiers .env au .gitignore s'ils n'y sont pas d√©j√†
log_info "Mise √† jour du .gitignore..."
if [ -f ".gitignore" ]; then
    if ! grep -q "^env/\\.env\\." .gitignore; then
        if echo -e "\n# Variables d'environnement\nenv/.env.*" >> .gitignore; then
            GITIGNORE_STATUS="‚úÖ"
            log_success "Fichiers .env ajout√©s au .gitignore"
        else
            log_warning "Erreur lors de la mise √† jour du .gitignore"
        fi
    else
        GITIGNORE_STATUS="‚úÖ"
        log_info "Les fichiers .env sont d√©j√† dans le .gitignore"
    fi
else
    if echo -e "# Variables d'environnement\nenv/.env.*" > .gitignore; then
        GITIGNORE_STATUS="‚úÖ"
        log_success "Nouveau fichier .gitignore cr√©√© avec les fichiers .env"
    else
        log_warning "Erreur lors de la cr√©ation du .gitignore"
    fi
fi

log_success "Configuration de l'environnement termin√©e!"
echo -e "\nüìã R√©sum√© des actions effectu√©es :"
echo "----------------------------------------"
echo "${ENV_DIR_STATUS} Dossier env"
echo "${ENV_API_STATUS} Fichier .env.api"
echo "${ENV_WEB_STATUS} Fichier .env.web"
echo "${ENV_MOBILE_STATUS} Fichier .env.mobile"
echo "${GITIGNORE_STATUS} Configuration du .gitignore"
echo "----------------------------------------"

# V√©rifier si toutes les actions ont r√©ussi
if [ "$ENV_DIR_STATUS" = "‚úÖ" ] && [ "$ENV_API_STATUS" = "‚úÖ" ] && [ "$ENV_WEB_STATUS" = "‚úÖ" ] && [ "$ENV_MOBILE_STATUS" = "‚úÖ" ] && [ "$GITIGNORE_STATUS" = "‚úÖ" ]; then
    echo "üöÄ Tout est configur√© ! Vous pouvez maintenant lancer les services avec bin/up all"
else
    echo "‚ö†Ô∏è  Certaines actions ont √©chou√©, v√©rifiez les erreurs ci-dessus"
fi 