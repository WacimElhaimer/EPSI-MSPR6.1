#!/bin/bash

echo "ğŸ”„ Mise Ã  jour du projet..."

# Fonction pour gÃ©rer les erreurs
handle_error() {
    echo "âŒ Erreur: $1"
    exit 1
}

# Fonction pour mettre Ã  jour un dÃ©pÃ´t
update_repo() {
    local dir=$1
    echo "ğŸ“‚ Mise Ã  jour de $dir..."
    
    # VÃ©rifier si on est dans un dÃ©pÃ´t git
    if [ ! -d ".git" ]; then
        handle_error "$dir n'est pas un dÃ©pÃ´t git"
    fi

    # Sauvegarder la branche actuelle
    local current_branch=$(git branch --show-current)
    echo "â„¹ï¸  Branche actuelle: $current_branch"

    # VÃ©rifier les changements non commitÃ©s
    if ! git diff --quiet HEAD; then
        echo "âš ï¸  Changements non commitÃ©s dÃ©tectÃ©s dans $dir"
        echo "ğŸ“ Sauvegarde des modifications..."
        git stash || handle_error "Impossible de sauvegarder les modifications"
        local changes_stashed=true
    fi

    # Mettre Ã  jour main
    echo "â¬‡ï¸  RÃ©cupÃ©ration des modifications distantes..."
    git fetch origin main || handle_error "Impossible de rÃ©cupÃ©rer les modifications"

    # Basculer sur main
    echo "ğŸ”„ Basculement sur main..."
    git checkout main || handle_error "Impossible de basculer sur main"

    # Merger les changements
    echo "ğŸ”€ Fusion des modifications..."
    git merge origin/main || handle_error "Conflit lors de la fusion"

    # Retourner Ã  la branche prÃ©cÃ©dente si diffÃ©rente de main
    if [ "$current_branch" != "main" ]; then
        echo "ğŸ”„ Retour Ã  la branche $current_branch..."
        git checkout "$current_branch" || handle_error "Impossible de retourner Ã  la branche prÃ©cÃ©dente"
        
        # Merger les changements de main dans la branche courante
        echo "ğŸ”€ Fusion de main dans $current_branch..."
        git merge main || handle_error "Conflit lors de la fusion avec la branche courante"
    fi

    # Restaurer les modifications si nÃ©cessaire
    if [ "$changes_stashed" = true ]; then
        echo "ğŸ“ Restauration des modifications locales..."
        git stash pop || handle_error "Impossible de restaurer les modifications"
    fi

    echo "âœ… Mise Ã  jour de $dir terminÃ©e"
}

# Mise Ã  jour du dÃ©pÃ´t principal
echo "ğŸ” Mise Ã  jour du dÃ©pÃ´t principal..."
update_repo "."

# Mise Ã  jour des requirements.txt si dans l'API
if [ -f "api/requirements.txt" ]; then
    echo "ğŸ“ Mise Ã  jour des requirements.txt..."
    ./bin/setup-api
fi

# Mise Ã  jour des sous-dossiers si nÃ©cessaire
for dir in api web mobile; do
    if [ -d "$dir" ]; then
        echo "ğŸ“‚ EntrÃ©e dans $dir..."
        cd $dir
        update_repo "."
        cd ..
    fi
done

echo "âœ… Mise Ã  jour globale terminÃ©e avec succÃ¨s!"
echo "ğŸ“Š RÃ©sumÃ© des mises Ã  jour:"
echo "- DÃ©pÃ´t principal"
for dir in api web mobile; do
    if [ -d "$dir" ]; then
        echo "- $dir"
    fi
done 