#!/bin/bash

# Variables pour suivre l'√©tat des actions
VENV_STATUS="‚ùå"
DEPS_STATUS="‚ùå"
REQ_STATUS="‚ùå"
FOLDERS_STATUS="‚ùå"
DB_STATUS="‚ùå"
MIGRATIONS_STATUS="‚ùå"

echo "üöÄ Installation et configuration de l'API..."

# V√©rifier si nous sommes dans le bon dossier
if [ ! -d "api" ]; then
    echo "‚ùå Erreur: Dossier 'api' non trouv√©"
    echo "‚û°Ô∏è  Ex√©cutez cette commande depuis la racine du projet"
    exit 1
fi

# V√©rifier si sqlite3 est install√©
if ! command -v sqlite3 >/dev/null 2>&1; then
    echo "‚ùå Erreur: sqlite3 n'est pas install√©"
    echo "‚û°Ô∏è  Veuillez installer sqlite3 avant de continuer"
    exit 1
fi

# V√©rifier si pip est install√©
if ! command -v pip >/dev/null 2>&1; then
    echo "‚ùå Erreur: pip n'est pas install√©"
    exit 1
fi

# Entrer dans le dossier api
cd api

# Cr√©er/activer un environnement virtuel si n√©cessaire
if [ ! -d "venv" ]; then
    echo "üîß Cr√©ation d'un environnement virtuel..."
    python -m venv venv
fi

# Activer l'environnement virtuel
source venv/bin/activate 2>/dev/null || source venv/Scripts/activate 2>/dev/null

if [ $? -eq 0 ]; then
    VENV_STATUS="‚úÖ"
else
    echo "‚ùå Erreur: Impossible d'activer l'environnement virtuel"
    exit 1
fi

# Installer les d√©pendances si requirements.txt existe
if [ -f "requirements.txt" ]; then
    echo "üì• Installation des d√©pendances existantes..."
    if pip install -r requirements.txt; then
        DEPS_STATUS="‚úÖ"
    else
        echo "‚ùå Erreur: Installation des d√©pendances √©chou√©e"
        exit 1
    fi
fi

# G√©n√©rer le nouveau requirements.txt
echo "üìù G√©n√©ration du nouveau requirements.txt..."
if pip freeze > requirements.txt; then
    REQ_STATUS="‚úÖ"
else
    echo "‚ùå Erreur: Impossible de g√©n√©rer requirements.txt"
fi

# Cr√©er les dossiers n√©cessaires
echo "üìÅ Cr√©ation des dossiers n√©cessaires..."
if mkdir -p assets/database; then
    FOLDERS_STATUS="‚úÖ"
else
    echo "‚ùå Erreur: Impossible de cr√©er les dossiers"
fi

# Sauvegarder l'ancienne base de donn√©es si elle existe
if [ -f "assets/database/arosaje.db" ]; then
    echo "üíæ Sauvegarde de la base de donn√©es existante..."
    cp assets/database/arosaje.db assets/database/arosaje.db.backup
fi

# Initialiser la base de donn√©es
echo "üóÑÔ∏è  Initialisation de la base de donn√©es..."
if python init_db.py; then
    DB_STATUS="‚úÖ"
else
    echo "‚ùå Erreur lors de l'initialisation de la base de donn√©es"
    # Restaurer la sauvegarde si elle existe
    if [ -f "assets/database/arosaje.db.backup" ]; then
        echo "üîÑ Restauration de la sauvegarde..."
        mv assets/database/arosaje.db.backup assets/database/arosaje.db
    fi
    exit 1
fi

# Ex√©cuter les migrations Alembic
echo "üîÑ Application des migrations..."
if alembic upgrade head; then
    MIGRATIONS_STATUS="‚úÖ"
else
    echo "‚ùå Erreur lors de l'application des migrations"
    exit 1
fi

# V√©rifier si la base de donn√©es a √©t√© cr√©√©e et est accessible
if [ -f "assets/database/arosaje.db" ]; then
    echo "üîç V√©rification de la base de donn√©es..."
    if sqlite3 assets/database/arosaje.db ".tables" >/dev/null 2>&1; then
        echo "‚úÖ Base de donn√©es cr√©√©e et accessible!"
        # Supprimer la sauvegarde si tout est OK
        rm -f assets/database/arosaje.db.backup
    else
        echo "‚ùå La base de donn√©es existe mais semble corrompue"
        DB_STATUS="‚ùå"
        exit 1
    fi
else
    echo "‚ùå Erreur: La base de donn√©es n'a pas √©t√© cr√©√©e"
    DB_STATUS="‚ùå"
    exit 1
fi

# D√©sactiver l'environnement virtuel
deactivate

echo "‚úÖ Configuration termin√©e!"
echo "üìã R√©sum√© des actions effectu√©es :"
echo "----------------------------------------"
echo "${VENV_STATUS} Environnement virtuel configur√©"
echo "${DEPS_STATUS} D√©pendances install√©es"
echo "${REQ_STATUS} Fichier requirements.txt mis √† jour"
echo "${FOLDERS_STATUS} Dossiers cr√©√©s"
echo "${DB_STATUS} Base de donn√©es initialis√©e"
echo "${MIGRATIONS_STATUS} Migrations appliqu√©es"
echo "----------------------------------------"

# V√©rifier si toutes les actions ont r√©ussi
if [ "$VENV_STATUS" = "‚úÖ" ] && [ "$DEPS_STATUS" = "‚úÖ" ] && [ "$REQ_STATUS" = "‚úÖ" ] && [ "$FOLDERS_STATUS" = "‚úÖ" ] && [ "$DB_STATUS" = "‚úÖ" ] && [ "$MIGRATIONS_STATUS" = "‚úÖ" ]; then
    echo "üöÄ L'API est pr√™te √† √™tre utilis√©e!"
else
    echo "‚ö†Ô∏è  Certaines actions ont √©chou√©, v√©rifiez les erreurs ci-dessus"
fi 