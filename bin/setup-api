#!/bin/bash

echo "ğŸš€ Installation et configuration de l'API..."

# VÃ©rifier si nous sommes dans le bon dossier
if [ ! -d "api" ]; then
    echo "âŒ Erreur: Dossier 'api' non trouvÃ©"
    echo "â¡ï¸  ExÃ©cutez cette commande depuis la racine du projet"
    exit 1
fi

# VÃ©rifier si sqlite3 est installÃ©
if ! command -v sqlite3 >/dev/null 2>&1; then
    echo "âŒ Erreur: sqlite3 n'est pas installÃ©"
    echo "â¡ï¸  Veuillez installer sqlite3 avant de continuer"
    exit 1
fi

# VÃ©rifier si pip est installÃ©
if ! command -v pip >/dev/null 2>&1; then
    echo "âŒ Erreur: pip n'est pas installÃ©"
    exit 1
fi

# Entrer dans le dossier api
cd api

# CrÃ©er/activer un environnement virtuel si nÃ©cessaire
if [ ! -d "venv" ]; then
    echo "ğŸ”§ CrÃ©ation d'un environnement virtuel..."
    python -m venv venv
fi

# Activer l'environnement virtuel
source venv/bin/activate 2>/dev/null || source venv/Scripts/activate 2>/dev/null

if [ $? -ne 0 ]; then
    echo "âŒ Erreur: Impossible d'activer l'environnement virtuel"
    exit 1
fi

# Installer les dÃ©pendances si requirements.txt existe
if [ -f "requirements.txt" ]; then
    echo "ğŸ“¥ Installation des dÃ©pendances existantes..."
    pip install -r requirements.txt
    if [ $? -ne 0 ]; then
        echo "âŒ Erreur: Installation des dÃ©pendances Ã©chouÃ©e"
        exit 1
    fi
fi

# GÃ©nÃ©rer le nouveau requirements.txt
echo "ğŸ“ GÃ©nÃ©ration du nouveau requirements.txt..."
pip freeze > requirements.txt

# CrÃ©er les dossiers nÃ©cessaires
echo "ğŸ“ CrÃ©ation des dossiers nÃ©cessaires..."
mkdir -p assets/database

# Sauvegarder l'ancienne base de donnÃ©es si elle existe
if [ -f "assets/database/arosaje.db" ]; then
    echo "ğŸ’¾ Sauvegarde de la base de donnÃ©es existante..."
    cp assets/database/arosaje.db assets/database/arosaje.db.backup
fi

# Initialiser la base de donnÃ©es
echo "ğŸ—„ï¸  Initialisation de la base de donnÃ©es..."
python init_db.py
if [ $? -ne 0 ]; then
    echo "âŒ Erreur lors de l'initialisation de la base de donnÃ©es"
    # Restaurer la sauvegarde si elle existe
    if [ -f "assets/database/arosaje.db.backup" ]; then
        echo "ğŸ”„ Restauration de la sauvegarde..."
        mv assets/database/arosaje.db.backup assets/database/arosaje.db
    fi
    exit 1
fi

# ExÃ©cuter les migrations Alembic
echo "ğŸ”„ Application des migrations..."
alembic upgrade head
if [ $? -ne 0 ]; then
    echo "âŒ Erreur lors de l'application des migrations"
    exit 1
fi

# VÃ©rifier si la base de donnÃ©es a Ã©tÃ© crÃ©Ã©e et est accessible
if [ -f "assets/database/arosaje.db" ]; then
    echo "ğŸ” VÃ©rification de la base de donnÃ©es..."
    if sqlite3 assets/database/arosaje.db ".tables" >/dev/null 2>&1; then
        echo "âœ… Base de donnÃ©es crÃ©Ã©e et accessible!"
        # Supprimer la sauvegarde si tout est OK
        rm -f assets/database/arosaje.db.backup
    else
        echo "âŒ La base de donnÃ©es existe mais semble corrompue"
        exit 1
    fi
else
    echo "âŒ Erreur: La base de donnÃ©es n'a pas Ã©tÃ© crÃ©Ã©e"
    exit 1
fi

# DÃ©sactiver l'environnement virtuel
deactivate

echo "âœ… Configuration terminÃ©e!"
echo "ğŸ“‹ RÃ©sumÃ© des actions effectuÃ©es :"
echo "----------------------------------------"
echo "âœ“ Environnement virtuel configurÃ©"
echo "âœ“ DÃ©pendances installÃ©es"
echo "âœ“ Fichier requirements.txt mis Ã  jour"
echo "âœ“ Dossiers crÃ©Ã©s"
echo "âœ“ Base de donnÃ©es initialisÃ©e"
echo "âœ“ Migrations appliquÃ©es"
echo "----------------------------------------"
echo "ğŸš€ L'API est prÃªte Ã  Ãªtre utilisÃ©e!" 