#!/bin/bash

# Variables pour suivre l'Ã©tat des actions
VENV_STATUS="âŒ"
DEPS_STATUS="âŒ"
REQ_STATUS="âŒ"
FOLDERS_STATUS="âŒ"
DB_STATUS="âŒ"
MIGRATIONS_STATUS="âŒ"

echo "ğŸš€ Installation et configuration de l'API..."

# VÃ©rifier si nous sommes dans le bon dossier
if [ ! -d "api" ]; then
    echo "âŒ Erreur: Dossier 'api' non trouvÃ©"
    echo "â¡ï¸  ExÃ©cutez cette commande depuis la racine du projet"
    exit 1
fi

# VÃ©rifier si pip est installÃ©
if ! command -v pip >/dev/null 2>&1; then
    echo "âŒ Erreur: pip n'est pas installÃ©"
    exit 1
fi

# Entrer dans le dossier api
cd api

# CrÃ©er/activer un environnement virtuel si nÃ©cessaire
if [ ! -d "venv" ]; then
    echo "ğŸ”§ CrÃ©ation d'un environnement virtuel..."
    python -m venv venv
fi

# Activer l'environnement virtuel
source venv/bin/activate 2>/dev/null || source venv/Scripts/activate 2>/dev/null

if [ $? -eq 0 ]; then
    VENV_STATUS="âœ…"
else
    echo "âŒ Erreur: Impossible d'activer l'environnement virtuel"
    exit 1
fi

# Installer les dÃ©pendances si requirements.txt existe
if [ -f "requirements.txt" ]; then
    echo "ğŸ“¥ Installation des dÃ©pendances existantes..."
    if pip install -r requirements.txt; then
        DEPS_STATUS="âœ…"
    else
        echo "âŒ Erreur: Installation des dÃ©pendances Ã©chouÃ©e"
        exit 1
    fi
fi

# GÃ©nÃ©rer le nouveau requirements.txt
echo "ğŸ“ GÃ©nÃ©ration du nouveau requirements.txt..."
if pip freeze > requirements.txt; then
    REQ_STATUS="âœ…"
else
    echo "âŒ Erreur: Impossible de gÃ©nÃ©rer requirements.txt"
fi

# CrÃ©er les dossiers nÃ©cessaires
echo "ğŸ“ CrÃ©ation des dossiers nÃ©cessaires..."
if mkdir -p assets/img assets/temp_img assets/persisted_img; then
    FOLDERS_STATUS="âœ…"
    echo "âœ… Dossiers crÃ©Ã©s:"
    echo "   - assets/img"
    echo "   - assets/temp_img"
    echo "   - assets/persisted_img"
else
    echo "âŒ Erreur: Impossible de crÃ©er les dossiers"
fi

# DÃ©sactiver l'environnement virtuel
deactivate

echo "âœ… Configuration terminÃ©e!"
echo "ğŸ“‹ RÃ©sumÃ© des actions effectuÃ©es :"
echo "----------------------------------------"
echo "${VENV_STATUS} Environnement virtuel configurÃ©"
echo "${DEPS_STATUS} DÃ©pendances installÃ©es"
echo "${REQ_STATUS} Fichier requirements.txt mis Ã  jour"
echo "${FOLDERS_STATUS} Dossiers crÃ©Ã©s"
echo "----------------------------------------"

# VÃ©rifier si toutes les actions ont rÃ©ussi
if [ "$VENV_STATUS" = "âœ…" ] && [ "$DEPS_STATUS" = "âœ…" ] && [ "$REQ_STATUS" = "âœ…" ] && [ "$FOLDERS_STATUS" = "âœ…" ]; then
    echo "ğŸš€ L'API est prÃªte Ã  Ãªtre utilisÃ©e!"
    echo "â¡ï¸  Utilisez 'bin/up api' pour dÃ©marrer l'API"
else
    echo "âš ï¸  Certaines actions ont Ã©chouÃ©, vÃ©rifiez les erreurs ci-dessus"
fi 